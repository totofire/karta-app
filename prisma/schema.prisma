// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --------------------------------------
// 1. DEFINICIÓN DE ROLES Y ESTADOS
// --------------------------------------

enum Rol {
  SUPER_ADMIN // Vos: Ves todos los locales y métricas globales
  ADMIN       // Dueño: Ve y configura SU local
  MOZO        // Empleado: Opera mesas/cocina/barra, no configura
}

enum EstadoLocal {
  ACTIVO      // Local operativo, todo funciona
  SUSPENDIDO  // Falta de pago: Admin bloqueado, QR muestra "Servicio interrumpido"
  BAJA        // Cliente canceló: Acceso revocado, datos guardados (soft delete)
  DEMO        // Periodo de prueba: Funcionalidad completa por tiempo limitado
}

enum Plan {
  DEMO        // Período de prueba gratuito
  BASIC       // Plan base
  PRO         // Plan intermedio
  ENTERPRISE  // Plan full
}

model Local {
  id            Int          @id @default(autoincrement())
  nombre        String
  direccion     String?
  slug          String?      @unique // Ej: "bar-de-tito"
  
  estado        EstadoLocal  @default(DEMO)
  notasAdmin    String?      // Notas internas tuyas sobre el local
  
  // ── Plan y facturación ──────────────────────────────────────────
  plan          Plan         @default(DEMO)
  montoPlan     Float        @default(0)   // Lo que paga por mes (0 en demo)
  trialHasta    DateTime?                  // Fecha en que vence el período demo
  fechaVence    DateTime?                  // Vencimiento del período pago actual
  
  fechaAlta     DateTime     @default(now())

  usuarios      Usuario[]
  mesas         Mesa[]
  sectores      Sector[]
  categorias    Categoria[]
  productos     Producto[]
  sesiones      Sesion[]
  pedidos       Pedido[]
  configuracion Configuracion?
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String?  // Nullable: el admin no tiene password hasta que activa su cuenta
  
  rol       Rol      @default(ADMIN)
  activo    Boolean  @default(false) // Empieza inactivo hasta que activa con el invite
  
  // ── Invite flow ─────────────────────────────────────────────────
  inviteToken   String?   @unique  // Token que se manda por mail para activar cuenta
  inviteExpira  DateTime?          // El token expira a las 48hs de creado
  
  localId   Int?
  local     Local?   @relation(fields: [localId], references: [id])
  
  fechaAlta DateTime @default(now())

  @@index([localId])
}

// --------------------------------------
// 2. CONFIGURACIÓN E INFRAESTRUCTURA
// --------------------------------------

model Configuracion {
  id           Int     @id @default(autoincrement())
  horaApertura String  @default("08:00")
  horaCierre   String  @default("00:00")
  cajaAbierta  Boolean @default(true)
  
  localId      Int     @unique
  local        Local   @relation(fields: [localId], references: [id])
  mapaZonas Json?

}

model Sector {
  id      Int    @id @default(autoincrement())
  nombre  String
  orden   Int    @default(0)

  localId Int
  local   Local  @relation(fields: [localId], references: [id])

  @@unique([localId, nombre]) 
}

model Mesa {
  id       Int     @id @default(autoincrement())
  nombre   String
  qr_token String  @unique @default(cuid())
  activo   Boolean @default(true)
  sector   String  @default("General") 
  
  posX     Int     @default(0)
  posY     Int     @default(0)
  
  localId  Int
  local    Local   @relation(fields: [localId], references: [id])
  
  sesiones Sesion[]

  @@index([localId, activo])
}

// --------------------------------------
// 3. MENÚ (PRODUCTOS Y CATEGORÍAS)
// --------------------------------------

model Categoria {
  id             Int        @id @default(autoincrement())
  nombre         String
  orden          Int        @default(0)
  imprimirCocina Boolean    @default(true)
  
  localId        Int
  local          Local      @relation(fields: [localId], references: [id])
  
  productos      Producto[]
  
  @@index([localId, orden])
}

model Producto {
  id          Int     @id @default(autoincrement())
  nombre      String
  descripcion String?
  precio      Float
  imagen      String?
  activo      Boolean @default(true)
  orden       Int     @default(0)
  
  categoriaId Int
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  
  localId     Int
  local       Local     @relation(fields: [localId], references: [id])
  
  items       ItemPedido[]

  @@index([localId, categoriaId, activo])
}

// --------------------------------------
// 4. OPERATIVA (PEDIDOS Y SESIONES)
// --------------------------------------

model Sesion {
  id             Int       @id @default(autoincrement())
  
  mesaId         Int
  mesa           Mesa      @relation(fields: [mesaId], references: [id])
  
  localId        Int
  local          Local     @relation(fields: [localId], references: [id])

  fechaInicio    DateTime  @default(now())
  fechaFin       DateTime?
  totalVenta     Float     @default(0)
  nombreHost     String?

  tokenEfimero   String?   @unique
  expiraEn       DateTime?
  solicitaCuenta DateTime?

  pedidos        Pedido[]

  @@index([localId, fechaFin]) 
  @@index([mesaId, fechaFin])
}

model Pedido {
  id            Int          @id @default(autoincrement())
  
  sesionId      Int
  sesion        Sesion       @relation(fields: [sesionId], references: [id])
  
  localId       Int
  local         Local        @relation(fields: [localId], references: [id])

  nombreCliente String?
  estado        String       @default("PENDIENTE") // PENDIENTE, EN_PREPARACION, ENTREGADO, CANCELADO
  fecha         DateTime     @default(now())
  impreso       Boolean      @default(false)
  
  // Permite calcular el tiempo real de espera del cliente (fecha → fechaDespacho).
  fechaDespacho DateTime?

  items         ItemPedido[]

  @@index([localId, estado])
  @@index([sesionId])
}

model ItemPedido {
  id            Int      @id @default(autoincrement())
  cantidad      Int
  precio        Float
  observaciones String?
  estado        String   @default("PENDIENTE") // PENDIENTE, ENTREGADO

  pedidoId      Int
  pedido        Pedido   @relation(fields: [pedidoId], references: [id])
  
  productoId    Int
  producto      Producto @relation(fields: [productoId], references: [id])
}
