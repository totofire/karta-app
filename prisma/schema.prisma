// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --------------------------------------
// 1. DEFINICI칍N DE ROLES Y ESTADOS
// --------------------------------------

enum Rol {
  SUPER_ADMIN // Vos: Ves todos los locales y m칠tricas globales
  ADMIN       // Due침o: Ve y configura SU local
  MOZO        // Empleado: Opera mesas/cocina/barra, no configura
}

enum EstadoLocal {
  ACTIVO      // Local operativo, todo funciona
  SUSPENDIDO  // Falta de pago: Admin bloqueado, QR muestra "Servicio interrumpido"
  BAJA        // Cliente cancel칩: Acceso revocado, datos guardados (soft delete)
  DEMO        // Periodo de prueba: Funcionalidad completa por tiempo limitado
}

model Local {
  id            Int          @id @default(autoincrement())
  nombre        String
  direccion     String?
  slug          String?      @unique // Ej: "bar-de-tito"
  
  estado        EstadoLocal  @default(ACTIVO) // 游댠 Control maestro del servicio
  notasAdmin    String?      // Notas internas tuyas (ej: "Debe mayo")
  
  fechaAlta     DateTime     @default(now())

  // Relaciones: Un local es due침o de todo esto
  usuarios      Usuario[]
  mesas         Mesa[]
  sectores      Sector[]
  categorias    Categoria[]
  productos     Producto[]
  sesiones      Sesion[]
  pedidos       Pedido[]
  configuracion Configuracion?
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String
  
  // Seguridad y Tenancy
  rol       Rol      @default(ADMIN)
  activo    Boolean  @default(true) // 游댠 Para bloquear empleados individuales sin borrarlos
  
  localId   Int?     // Es opcional porque el SUPER_ADMIN no tiene local
  local     Local?   @relation(fields: [localId], references: [id])
  
  fechaAlta DateTime @default(now())

  @@index([localId])
}

// --------------------------------------
// 2. CONFIGURACI칍N E INFRAESTRUCTURA
// --------------------------------------

model Configuracion {
  id           Int     @id @default(autoincrement())
  horaApertura String  @default("08:00")
  horaCierre   String  @default("00:00")
  cajaAbierta  Boolean @default(true)
  
  // Relaci칩n 1 a 1 con Local
  localId      Int     @unique
  local        Local   @relation(fields: [localId], references: [id])
}

model Sector {
  id      Int    @id @default(autoincrement())
  nombre  String
  orden   Int    @default(0)

  localId Int
  local   Local  @relation(fields: [localId], references: [id])

  @@unique([localId, nombre]) 
}

model Mesa {
  id       Int     @id @default(autoincrement())
  nombre   String
  qr_token String  @unique @default(cuid())
  activo   Boolean @default(true)
  sector   String  @default("General") 
  
  posX     Int     @default(0)
  posY     Int     @default(0)
  
  localId  Int
  local    Local   @relation(fields: [localId], references: [id])
  
  sesiones Sesion[]

  @@index([localId, activo])
}

// --------------------------------------
// 3. MEN칔 (PRODUCTOS Y CATEGOR칈AS)
// --------------------------------------

model Categoria {
  id             Int        @id @default(autoincrement())
  nombre         String
  orden          Int        @default(0)
  imprimirCocina Boolean    @default(true)
  
  localId        Int
  local          Local      @relation(fields: [localId], references: [id])
  
  productos      Producto[]
  
  @@index([localId, orden])
}

model Producto {
  id          Int     @id @default(autoincrement())
  nombre      String
  descripcion String?
  precio      Float
  imagen      String?
  activo      Boolean @default(true)
  orden       Int     @default(0)
  
  categoriaId Int
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  
  localId     Int
  local       Local     @relation(fields: [localId], references: [id])
  
  items       ItemPedido[]

  @@index([localId, categoriaId, activo])
}

// --------------------------------------
// 4. OPERATIVA (PEDIDOS Y SESIONES)
// --------------------------------------

model Sesion {
  id             Int       @id @default(autoincrement())
  
  mesaId         Int
  mesa           Mesa      @relation(fields: [mesaId], references: [id])
  
  localId        Int       // Vital para reportes de venta por local
  local          Local     @relation(fields: [localId], references: [id])

  fechaInicio    DateTime  @default(now())
  fechaFin       DateTime?
  totalVenta     Float     @default(0)
  nombreHost     String?

  tokenEfimero   String?   @unique
  expiraEn       DateTime?
  solicitaCuenta DateTime?

  pedidos        Pedido[]

  @@index([localId, fechaFin]) 
  @@index([mesaId, fechaFin])
}

model Pedido {
  id            Int          @id @default(autoincrement())
  
  sesionId      Int
  sesion        Sesion       @relation(fields: [sesionId], references: [id])
  
  localId       Int          // Desnormalizaci칩n para filtrar pedidos por local r치pidamente
  local         Local        @relation(fields: [localId], references: [id])

  nombreCliente String?
  estado        String       @default("PENDIENTE") // PENDIENTE, EN_PREPARACION, ENTREGADO, CANCELADO
  fecha         DateTime     @default(now())
  impreso       Boolean      @default(false)
  
  items         ItemPedido[]

  @@index([localId, estado]) // Para KDS (Cocina/Barra) del local espec칤fico
  @@index([sesionId])
}

model ItemPedido {
  id            Int      @id @default(autoincrement())
  cantidad      Int
  precio        Float    // Guardamos el precio al momento de la compra (hist칩rico)
  observaciones String?
  estado        String   @default("PENDIENTE") // PENDIENTE, ENTREGADO

  pedidoId      Int
  pedido        Pedido   @relation(fields: [pedidoId], references: [id])
  
  productoId    Int
  producto      Producto @relation(fields: [productoId], references: [id])
}